

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=light>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Andy Zhang">
  <meta name="keywords" content="Java, Programming">
  
    <meta name="description" content="小程序登录经历过了几次改版，其中有很多的细小知识点值得我们注意，本文介绍微信小程序登录的正确打开方式。">
<meta property="og:type" content="article">
<meta property="og:title" content="小程序登录的正确打开方式">
<meta property="og:url" content="https://ivivisoft.com/Wechat/Wechat-Login/index.html">
<meta property="og:site_name" content="IvIvI">
<meta property="og:description" content="小程序登录经历过了几次改版，其中有很多的细小知识点值得我们注意，本文介绍微信小程序登录的正确打开方式。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-03-03T04:00:50.000Z">
<meta property="article:modified_time" content="2022-03-03T04:03:51.739Z">
<meta property="article:author" content="Andy Zhang">
<meta property="article:tag" content="登录">
<meta name="twitter:card" content="summary_large_image">
  
  
  <title>小程序登录的正确打开方式 - IvIvI</title>
  <!-- anti-flicker snippet (recommended)  -->
<style>.async-hide { opacity: 0 !important} </style>
<script>(function(a,s,y,n,c,h,i,d,e){s.className+=' '+y;h.start=1*new Date;
h.end=i=function(){s.className=s.className.replace(RegExp(' ?'+y),'')};
(a[n]=a[n]||[]).hide=h;setTimeout(function(){i();h.end=null},c);h.timeout=c;
})(window,document.documentElement,'async-hide','dataLayer',4000,
{'GTM-T9HKC8K':true});</script>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-T9HKC8K');</script>
  <!-- End Google Tag Manager -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8488991078175700"
     crossorigin="anonymous"></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"ivivisoft.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="IvIvI" type="application/atom+xml">
</head>


<body>
  <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T9HKC8K"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  <header style="height: 50vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>IvIvI</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.2)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="小程序登录的正确打开方式">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-03-03 12:00" pubdate>
        2022年3月3日 中午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      17k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      143 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">小程序登录的正确打开方式</h1>
            
            <div class="markdown-body">
              <h4 id="小程序网络组件"><a href="#小程序网络组件" class="headerlink" title="小程序网络组件"></a>小程序网络组件</h4><p><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/network/request/RequestTask.html">RequestTask</a> <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html">wx.request(Object object)</a></p>
<p><strong>RequestTask说明</strong></p>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/network/request/RequestTask.abort.html">RequestTask.abort()</a></td>
<td>中断请求任务。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/network/request/RequestTask.onHeadersReceived.html">RequestTask.onHeadersReceived(function callback)</a></td>
<td>监听 HTTP Response Header 事件。会比请求完成事件更早。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/network/request/RequestTask.offHeadersReceived.html">RequestTask.offHeadersReceived(function callback)</a></td>
<td>取消监听 HTTP Response Header 事件。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/network/request/RequestTask.onChunkReceived.html">RequestTask.onChunkReceived(function callback)</a></td>
<td>监听 Transfer-Encoding Chunk Received 事件。当接收到新的chunk时触发。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/network/request/RequestTask.offChunkReceived.html">RequestTask.offChunkReceived(function callback)</a></td>
<td>取消监听 Transfer-Encoding Chunk Received 事件。</td>
</tr>
</tbody></table>
<p><strong>wx.request(Object object)属性</strong></p>
<p><em>此处只列比较常用的属性，全部属性请查看<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html">链接</a>。</em></p>
<table>
<thead>
<tr>
<th>属性</th>
<th>类型</th>
<th>默认值</th>
<th>必填</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>url</td>
<td>string</td>
<td></td>
<td>是</td>
<td>开发者服务器接口地址</td>
</tr>
<tr>
<td>data</td>
<td>string&#x2F;object&#x2F;ArrayBuffer</td>
<td></td>
<td>否</td>
<td>请求的参数</td>
</tr>
<tr>
<td>header</td>
<td>Object</td>
<td></td>
<td>否</td>
<td>设置请求的 header，header 中不能设置 Referer。 <code>content-type</code> 默认为 <code>application/json</code></td>
</tr>
<tr>
<td>timeout</td>
<td>number</td>
<td></td>
<td>否</td>
<td>超时时间，单位为毫秒</td>
</tr>
<tr>
<td>method</td>
<td>string</td>
<td>GET</td>
<td>否</td>
<td>HTTP 请求方法</td>
</tr>
<tr>
<td>success</td>
<td>function</td>
<td></td>
<td>否</td>
<td>接口调用成功的回调函数</td>
</tr>
<tr>
<td>fail</td>
<td>function</td>
<td></td>
<td>否</td>
<td>接口调用失败的回调函数</td>
</tr>
<tr>
<td>complete</td>
<td>function</td>
<td></td>
<td>否</td>
<td>接口调用结束的回调函数（调用成功、失败都会执行）哪怕是abort掉的请求！</td>
</tr>
</tbody></table>
<p><strong>总结一下：所有的小程序接口基本上都有两个特征：</strong></p>
<ol>
<li><p>参数都是一个对象。便于记忆的同时方便扩展。</p>
</li>
<li><p>都有相同的结果处理方式：都有success、fail、complete三个回调属性。</p>
</li>
</ol>
<p><strong>接口执行的各种情况下的errMsg对象介绍。</strong></p>
<table>
<thead>
<tr>
<th>回调属性</th>
<th>errMsg对象</th>
</tr>
</thead>
<tbody><tr>
<td>success</td>
<td>{errMsg:”request:ok”…}</td>
</tr>
<tr>
<td>fail</td>
<td>{errMsg:”request:fail “…} 有的系统这个fail后面有个空格，所以要使用这个判断，最好是使用正则表达式。也可以使用indexOf函数，大于-1进行判断。</td>
</tr>
<tr>
<td>abort</td>
<td>{errMsg:”request:fail abort”…}</td>
</tr>
</tbody></table>
<p>   <strong>示例代码</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> reqTask = wx.<span class="hljs-title function_">request</span>(&#123;<br>    <span class="hljs-attr">url</span>: <span class="hljs-title function_">getApp</span>().<span class="hljs-property">globalData</span>.<span class="hljs-property">api</span>,<br>    <span class="hljs-title function_">success</span>(<span class="hljs-params">res</span>) &#123;<br>      <span class="hljs-keyword">if</span> (res.<span class="hljs-property">errMsg</span> === <span class="hljs-string">&quot;request:ok&quot;</span>) <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;res&quot;</span>, res);<br>    &#125;,<br>    <span class="hljs-title function_">fail</span>(<span class="hljs-params">err</span>) &#123;<br>      <span class="hljs-comment">// if(err.errMsg.indexOf(&#x27;request:fail&#x27;)&gt;-1) console.log(&#x27;err&#x27;, err);</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/^request:fail/i</span>.<span class="hljs-title function_">test</span>(err.<span class="hljs-property">errMsg</span>)) <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;err&quot;</span>, err);<br>    &#125;,<br>    <span class="hljs-title function_">complete</span>(<span class="hljs-params">res</span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;resOrErr&quot;</span>, res);<br>    &#125;,<br>  &#125;);<br> <span class="hljs-keyword">const</span> <span class="hljs-title function_">reqTaskOnHeadersReceived</span> = (<span class="hljs-params">headers</span>) =&gt; &#123;<br>    reqTask.<span class="hljs-title function_">offHeadersReceived</span>(reqTaskOnHeadersReceived);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;headers&quot;</span>, headers);<br>    <span class="hljs-comment">// 由于请求还未完全结束，所以我们没办法获得请求的状态码，但是我们可以通过返回的requestBody的长度来进行判断。</span><br>    <span class="hljs-comment">// 两点说明：1. 两个~~可以把字符串数字快速转化为数字。</span><br>    <span class="hljs-comment">// 2. 为什么取小于19，是由于后台返回没有权限的requestBody的时候Content-length为“18”，正常情况下是大于19的。所以具体多少得看一下具体情况。</span><br>    <span class="hljs-keyword">if</span> (~~headers.<span class="hljs-property">header</span>[<span class="hljs-string">&quot;Content-length&quot;</span>] &lt; <span class="hljs-number">19</span>) reqTask.<span class="hljs-title function_">abort</span>();<br>  &#125;;<br>  reqTask.<span class="hljs-title function_">onHeadersReceived</span>(reqTaskOnHeadersReceived);<br></code></pre></td></tr></table></figure>



<h4 id="小程序登录接口"><a href="#小程序登录接口" class="headerlink" title="小程序登录接口"></a>小程序登录接口</h4><ol>
<li><p><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserProfile.html">wx.getUserProfile(Object object)</a></p>
<p>获取用户信息。页面产生点击事件（例如 <code>button</code> 上 <code>bindtap</code> 的回调中）后才可调用，每次请求都会弹出授权窗口，用户同意后返回 <code>userInfo</code>。该接口用于替换 <code>wx.getUserInfo</code>，详见 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/community/develop/doc/000cacfa20ce88df04cb468bc52801?highLine=login">用户信息接口调整说明</a>。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.checkSession.html">wx.checkSession(Object object)</a></p>
<p>检查登录态是否过期。 通过 wx.login 接口获得的用户登录态拥有一定的时效性。用户越久未使用小程序，用户登录态越有可能失效。反之如果用户一直在使用小程序，则用户登录态一直保持有效。具体时效逻辑由微信维护，对开发者透明。开发者只需要调用 wx.checkSession 接口检测当前用户登录态是否有效。</p>
<p>登录态过期后开发者可以再调用 wx.login 获取新的用户登录态。调用成功说明当前 session_key 未过期，调用失败说明 session_key 已过期。更多使用方法详见 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html">小程序登录</a>。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html">wx.login(Object object)</a></p>
<p>调用接口获取登录凭证（code）。通过凭证进而换取用户登录态信息，包括用户在当前小程序的唯一标识（openid）、微信开放平台帐号下的唯一标识（unionid，若当前小程序已绑定到微信开放平台帐号）及本次登录的会话密钥（session_key）等。用户数据的加解密通讯需要依赖会话密钥完成。更多使用方法详见 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html">小程序登录</a>。</p>
</li>
</ol>
<h4 id="后端登录接口代码实现"><a href="#后端登录接口代码实现" class="headerlink" title="后端登录接口代码实现"></a>后端登录接口代码实现</h4><p><strong>后端使用NodeJS，web框架KOA版本^2.13.4，路由框架@koa&#x2F;router版本^10.1.1，框架request，版本 ^2.88.2，jsonwebtoken用来加密解密token信息，版本^8.5.1</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// app.js</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;koa&quot;</span>);<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Router</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;@koa/router&quot;</span>);<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">WeixinAuth</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./lib/koa2-weixin-auth&quot;</span>);<br><span class="hljs-keyword">const</span> jsonwebtoken = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;jsonwebtoken&quot;</span>);<br><br><span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();<br><span class="hljs-comment">// 小程序机票信息</span><br><span class="hljs-keyword">const</span> miniProgramAppId = <span class="hljs-string">&quot;*********&quot;</span>;<br><span class="hljs-keyword">const</span> miniProgramAppSecret = <span class="hljs-string">&quot;***********&quot;</span>;<br><span class="hljs-keyword">const</span> weixinAuth = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeixinAuth</span>(miniProgramAppId, miniProgramAppSecret);<br><br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">JWT_SECRET</span> = <span class="hljs-string">&quot;JWTSECRET&quot;</span>;<br><span class="hljs-comment">// 路由中间件需要安装@koa/router</span><br><span class="hljs-comment">// 开启一个带群组的路由</span><br><span class="hljs-keyword">const</span> router = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Router</span>(&#123;<br>  <span class="hljs-attr">prefix</span>: <span class="hljs-string">&quot;/user&quot;</span>,<br>&#125;);<br><span class="hljs-comment">// 这是正规的登陆方法</span><br><span class="hljs-comment">// 添加一个参数，sessionKeyIsValid，代表sessionKey是否还有效</span><br>router.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/weixin-login&quot;</span>, <span class="hljs-keyword">async</span> (ctx) =&gt; &#123;<br>  <span class="hljs-keyword">let</span> &#123; code, userInfo, encryptedData, iv, sessionKeyIsValid &#125; =<br>    ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>;<br>   <span class="hljs-comment">// 解析openid</span><br>  <span class="hljs-keyword">const</span> token = <span class="hljs-keyword">await</span> weixinAuth.<span class="hljs-title function_">getAccessToken</span>(code);<br>  userInfo.<span class="hljs-property">openid</span> = token.<span class="hljs-property">data</span>.<span class="hljs-property">openid</span>;<br>  <span class="hljs-comment">// 这里可以自己进行处理，比方说记录到数据库,处理token等</span><br>  <span class="hljs-keyword">let</span> authorizationToken = jsonwebtoken.<span class="hljs-title function_">sign</span>(<br>    &#123; <span class="hljs-attr">name</span>: userInfo.<span class="hljs-property">nickName</span> &#125;,<br>    <span class="hljs-variable constant_">JWT_SECRET</span>,<br>    &#123; <span class="hljs-attr">expiresIn</span>: <span class="hljs-string">&quot;1d&quot;</span> &#125;<br>  );<br>  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(userInfo, &#123; authorizationToken &#125;);<br>  ctx.<span class="hljs-property">status</span> = <span class="hljs-number">200</span>;<br>  ctx.<span class="hljs-property">body</span> = &#123;<br>    <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>    <span class="hljs-attr">msg</span>: <span class="hljs-string">&quot;ok&quot;</span>,<br>    <span class="hljs-attr">data</span>: userInfo,<br>  &#125;;<br>&#125;);<br></code></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// lib/koa2-weixin-auth.js</span><br><span class="hljs-keyword">const</span> querystring = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;querystring&quot;</span>);<br><span class="hljs-keyword">const</span> request = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;request&quot;</span>);<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">AccessToken</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) &#123;<br>  <span class="hljs-keyword">if</span> (!(<span class="hljs-variable language_">this</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">AccessToken</span>)) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AccessToken</span>(data);<br>  &#125;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = data;<br>&#125;;<br><br><span class="hljs-comment">/*!</span><br><span class="hljs-comment"> * 检查AccessToken是否有效，检查规则为当前时间和过期时间进行对比</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Examples:</span><br><span class="hljs-comment"> * ```</span><br><span class="hljs-comment"> * token.isValid();</span><br><span class="hljs-comment"> * ```</span><br><span class="hljs-comment"> */</span><br><span class="hljs-title class_">AccessToken</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">isValid</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    !!<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">session_key</span> &amp;&amp;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>() &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">create_at</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">expires_in</span> * <span class="hljs-number">1000</span><br>  );<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据appid和appsecret创建OAuth接口的构造函数</span><br><span class="hljs-comment"> * 如需跨进程跨机器进行操作，access token需要进行全局维护</span><br><span class="hljs-comment"> * 使用使用token的优先级是：</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 1. 使用当前缓存的token对象</span><br><span class="hljs-comment"> * 2. 调用开发传入的获取token的异步方法，获得token之后使用（并缓存它）。</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> * Examples:</span><br><span class="hljs-comment"> * ```</span><br><span class="hljs-comment"> * var OAuth = require(&#x27;oauth&#x27;);</span><br><span class="hljs-comment"> * var api = new OAuth(&#x27;appid&#x27;, &#x27;secret&#x27;);</span><br><span class="hljs-comment"> * ```</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">String</span>&#125; appid 在公众平台上申请得到的appid</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">String</span>&#125; appsecret 在公众平台上申请得到的app secret</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Auth</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">appid, appsecret</span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">appid</span> = appid;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">appsecret</span> = appsecret;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span> = &#123;&#125;;<br><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">getToken</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">openid</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span>[openid];<br>  &#125;;<br><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveToken</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">openid, token</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span>[openid] = token;<br>  &#125;;<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 获取授权页面的URL地址</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">String</span>&#125; redirect 授权后要跳转的地址</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">String</span>&#125; state 开发者可提供的数据</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">String</span>&#125; scope 作用范围，值为snsapi_userinfo和snsapi_base，前者用于弹出，后者用于跳转</span><br><span class="hljs-comment"> */</span><br><span class="hljs-title class_">Auth</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">getAuthorizeURL</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">redirect_uri, scope, state</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> url = <span class="hljs-string">&quot;https://open.weixin.qq.com/connect/oauth2/authorize&quot;</span>;<br>    <span class="hljs-keyword">let</span> info = &#123;<br>      <span class="hljs-attr">appid</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">appid</span>,<br>      <span class="hljs-attr">redirect_uri</span>: redirect_uri,<br>      <span class="hljs-attr">scope</span>: scope || <span class="hljs-string">&quot;snsapi_base&quot;</span>,<br>      <span class="hljs-attr">state</span>: state || <span class="hljs-string">&quot;&quot;</span>,<br>      <span class="hljs-attr">response_type</span>: <span class="hljs-string">&quot;code&quot;</span>,<br>    &#125;;<br>    <span class="hljs-title function_">resolve</span>(url + <span class="hljs-string">&quot;?&quot;</span> + querystring.<span class="hljs-title function_">stringify</span>(info) + <span class="hljs-string">&quot;#wechat_redirect&quot;</span>);<br>  &#125;);<br>&#125;;<br><br><span class="hljs-comment">/*!</span><br><span class="hljs-comment"> * 处理token，更新过期时间</span><br><span class="hljs-comment"> */</span><br><span class="hljs-title class_">Auth</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">processToken</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) &#123;<br>  data.<span class="hljs-property">create_at</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>();<br>  <span class="hljs-comment">// 存储token</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveToken</span>(data.<span class="hljs-property">openid</span>, data);<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">AccessToken</span>(data);<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据授权获取到的code，换取access token和openid</span><br><span class="hljs-comment"> * 获取openid之后，可以调用`wechat.API`来获取更多信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">String</span>&#125; code 授权获取到的code</span><br><span class="hljs-comment"> */</span><br><span class="hljs-title class_">Auth</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">getAccessToken</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">code</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> url = <span class="hljs-string">&quot;https://api.weixin.qq.com/sns/jscode2session&quot;</span>;<br>    <span class="hljs-comment">//由于此框架版本很久没有更新了，此处地址发生了变化，需要修改为以上地址，不然会出现</span><br>    <span class="hljs-comment">//41008错误。这也是没有直接使用框架，引用本地使用的原因。</span><br>    <span class="hljs-comment">// const url = &quot;https://api.weixin.qq.com/sns/oauth2/access_token&quot;;</span><br>    <span class="hljs-keyword">const</span> info = &#123;<br>      <span class="hljs-attr">appid</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">appid</span>,<br>      <span class="hljs-attr">secret</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">appsecret</span>,<br>      <span class="hljs-attr">js_code</span>: code,<br>      <span class="hljs-attr">grant_type</span>: <span class="hljs-string">&quot;authorization_code&quot;</span>,<br>    &#125;;<br>    request.<span class="hljs-title function_">post</span>(url, &#123; <span class="hljs-attr">form</span>: info &#125;, <span class="hljs-function">(<span class="hljs-params">err, res, body</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (err) &#123;<br>        <span class="hljs-title function_">reject</span>(err);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(body);<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processToken</span>(data));<br>      &#125;<br>    &#125;);<br>  &#125;);<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据refresh token，刷新access token，调用getAccessToken后才有效</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">String</span>&#125; refreshToken refreshToken</span><br><span class="hljs-comment"> */</span><br><span class="hljs-title class_">Auth</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">refreshAccessToken</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">refreshToken</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> url = <span class="hljs-string">&quot;https://api.weixin.qq.com/sns/oauth2/refresh_token&quot;</span>;<br>    <span class="hljs-keyword">var</span> info = &#123;<br>      <span class="hljs-attr">appid</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">appid</span>,<br>      <span class="hljs-attr">grant_type</span>: <span class="hljs-string">&quot;refresh_token&quot;</span>,<br>      <span class="hljs-attr">refresh_token</span>: refreshToken,<br>    &#125;;<br>    request.<span class="hljs-title function_">post</span>(url, &#123; <span class="hljs-attr">form</span>: info &#125;, <span class="hljs-function">(<span class="hljs-params">err, res, body</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (err) &#123;<br>        <span class="hljs-title function_">reject</span>(err);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(body);<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processToken</span>(data));<br>      &#125;<br>    &#125;);<br>  &#125;);<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据openid，获取用户信息。</span><br><span class="hljs-comment"> * 当access token无效时，自动通过refresh token获取新的access token。然后再获取用户信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Object|String</span>&#125; options 传入openid或者参见Options</span><br><span class="hljs-comment"> */</span><br><span class="hljs-title class_">Auth</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">getUser</span> = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">openid</span>) &#123;<br>  <span class="hljs-keyword">const</span> data = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getToken</span>(openid);<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;getUser&quot;</span>, data);<br>  <span class="hljs-keyword">if</span> (!data) &#123;<br>    <span class="hljs-keyword">var</span> error = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<br>      <span class="hljs-string">&quot;No token for &quot;</span> + options.<span class="hljs-property">openid</span> + <span class="hljs-string">&quot;, please authorize first.&quot;</span><br>    );<br>    error.<span class="hljs-property">name</span> = <span class="hljs-string">&quot;NoOAuthTokenError&quot;</span>;<br>    <span class="hljs-keyword">throw</span> error;<br>  &#125;<br>  <span class="hljs-keyword">const</span> token = <span class="hljs-title class_">AccessToken</span>(data);<br>  <span class="hljs-keyword">var</span> accessToken;<br>  <span class="hljs-keyword">if</span> (token.<span class="hljs-title function_">isValid</span>()) &#123;<br>    accessToken = token.<span class="hljs-property">data</span>.<span class="hljs-property">session_key</span>;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">var</span> newToken = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">refreshAccessToken</span>(token.<span class="hljs-property">data</span>.<span class="hljs-property">refresh_token</span>);<br>    accessToken = newToken.<span class="hljs-property">data</span>.<span class="hljs-property">session_key</span>;<br>  &#125;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;accessToken&quot;</span>, accessToken);<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_getUser</span>(openid, accessToken);<br>&#125;;<br><br><span class="hljs-title class_">Auth</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_getUser</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">openid, accessToken, lang</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> url = <span class="hljs-string">&quot;https://api.weixin.qq.com/sns/userinfo&quot;</span>;<br>    <span class="hljs-keyword">const</span> info = &#123;<br>      <span class="hljs-attr">access_token</span>: accessToken,<br>      <span class="hljs-attr">openid</span>: openid,<br>      <span class="hljs-attr">lang</span>: lang || <span class="hljs-string">&quot;zh_CN&quot;</span>,<br>    &#125;;<br>    request.<span class="hljs-title function_">post</span>(url, &#123; <span class="hljs-attr">form</span>: info &#125;, <span class="hljs-function">(<span class="hljs-params">err, res, body</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (err) &#123;<br>        <span class="hljs-title function_">reject</span>(err);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(body));<br>      &#125;<br>    &#125;);<br>  &#125;);<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据code，获取用户信息。</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">String</span>&#125; code 授权获取到的code</span><br><span class="hljs-comment"> */</span><br><span class="hljs-title class_">Auth</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">getUserByCode</span> = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">code</span>) &#123;<br>  <span class="hljs-keyword">const</span> token = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAccessToken</span>(code);<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUser</span>(token.<span class="hljs-property">data</span>.<span class="hljs-property">openid</span>);<br>&#125;;<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">Auth</span>;<br></code></pre></td></tr></table></figure>

<h4 id="小程序端登录代码实现"><a href="#小程序端登录代码实现" class="headerlink" title="小程序端登录代码实现"></a>小程序端登录代码实现</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-comment">&lt;!--pages/index.wxml--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;page-section&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">text</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;page-section__title&quot;</span>&gt;</span>微信登录<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn-area&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">button</span>  <span class="hljs-attr">bindtap</span>=<span class="hljs-string">&quot;getUserProfile&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;primary&quot;</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// pages/index.js</span><br><span class="hljs-title class_">Page</span>(&#123;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 页面的初始数据</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-attr">data</span>: &#123;&#125;,<br>  <span class="hljs-comment">// 正确的登录方式</span><br>  <span class="hljs-title function_">getUserProfile</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// 推荐使用wx.getUserProfile获取用户信息，开发者每次通过该接口获取用户个人信息均需用户确认</span><br>    <span class="hljs-comment">// 开发者妥善保管用户快速填写的头像昵称，避免重复弹窗</span><br>    wx.<span class="hljs-title function_">getUserProfile</span>(&#123;<br>      <span class="hljs-attr">desc</span>: <span class="hljs-string">&quot;用于完善会员资料&quot;</span>, <span class="hljs-comment">// 声明获取用户个人信息后的用途，后续会展示在弹窗中，请谨慎填写</span><br>      <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">let</span> &#123; userInfo, encryptedData, iv &#125; = res;<br>        <span class="hljs-keyword">const</span> <span class="hljs-title function_">requestLoginApi</span> = (<span class="hljs-params">code</span>) =&gt; &#123;<br>          <span class="hljs-comment">// 发起网络请求</span><br>          wx.<span class="hljs-title function_">request</span>(&#123;<br>            <span class="hljs-attr">url</span>: <span class="hljs-string">&quot;http://localhost:3000/user/weixin-login&quot;</span>,<br>            <span class="hljs-attr">method</span>: <span class="hljs-string">&quot;POST&quot;</span>,<br>            <span class="hljs-attr">header</span>: &#123;<br>              <span class="hljs-string">&quot;content-type&quot;</span>: <span class="hljs-string">&quot;application/json&quot;</span>,<br>            &#125;,<br>            <span class="hljs-attr">data</span>: &#123;<br>              code,<br>              userInfo,<br>              encryptedData,<br>              iv,<br>            &#125;,<br>            <span class="hljs-title function_">success</span>(<span class="hljs-params">res</span>) &#123;<br>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;请求成功&quot;</span>, res.<span class="hljs-property">data</span>);<br>              <span class="hljs-keyword">let</span> token = res.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>.<span class="hljs-property">authorizationToken</span>;<br>              wx.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">&quot;token&quot;</span>, token);<br>              <span class="hljs-title function_">onUserLogin</span>(token);<br>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;authorization&quot;</span>, token);<br>            &#125;,<br>            <span class="hljs-title function_">fail</span>(<span class="hljs-params">err</span>) &#123;<br>              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;请求异常&quot;</span>, err);<br>            &#125;,<br>          &#125;);<br>        &#125;;<br>        <span class="hljs-keyword">const</span> <span class="hljs-title function_">onUserLogin</span> = (<span class="hljs-params">token</span>) =&gt; &#123;<br>          <span class="hljs-title function_">getApp</span>().<span class="hljs-property">globalData</span>.<span class="hljs-property">token</span> = token;<br>          wx.<span class="hljs-title function_">showToast</span>(&#123;<br>            <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;登录成功了&quot;</span>,<br>          &#125;);<br>        &#125;;<br>        <span class="hljs-comment">//必须进行session是否过期检查，不然会出现第一次点击登录，服务器报Illegal Buffer</span><br>        <span class="hljs-comment">//的错误，但是第二次点击登录正常。</span><br>        wx.<span class="hljs-title function_">checkSession</span>(&#123;<br>          <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>            <span class="hljs-comment">// session_key 未过期，并且在本生命周期一直有效</span><br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;在登陆中&quot;</span>);<br>            <span class="hljs-keyword">let</span> token = wx.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">&quot;token&quot;</span>);<br>            <span class="hljs-keyword">if</span> (token) <span class="hljs-title function_">onUserLogin</span>(token);<br>          &#125;,<br>          <span class="hljs-attr">fail</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>            <span class="hljs-comment">// session_key已经失效，需要重新执行登录流程</span><br>            wx.<span class="hljs-title function_">login</span>(&#123;<br>              <span class="hljs-title function_">success</span>(<span class="hljs-params">res0</span>) &#123;<br>                <span class="hljs-keyword">if</span> (res0.<span class="hljs-property">code</span>) &#123;<br>                  <span class="hljs-title function_">requestLoginApi</span>(res0.<span class="hljs-property">code</span>);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;登录失败!&quot;</span> + res0.<span class="hljs-property">errMsg</span>);<br>                &#125;<br>              &#125;,<br>            &#125;);<br>          &#125;,<br>        &#125;);<br>      &#125;,<br>    &#125;);<br>  &#125;,<br>&#125;);<br><br></code></pre></td></tr></table></figure>

<h4 id="针对登录代码可以做哪些优化？"><a href="#针对登录代码可以做哪些优化？" class="headerlink" title="针对登录代码可以做哪些优化？"></a>针对登录代码可以做哪些优化？</h4><p>对于一个软件，就代码层面而言，需要追求最基本的几个方面（远不止这些，但是先姑且先做个好这些吧）：</p>
<ol>
<li><p>可维护性（maintainability）</p>
<p>所谓的“维护”无外乎就是修改 bug、修改老的代码、添加新的代码之类的工作。所谓“代码易维护”就是指，在不破坏原有代码设计、不引入新的 bug 的情况下，能够快速地修改或者添加代码。所谓“代码不易维护”就是指，修改或者添加代码需要冒着极大的引入新 bug 的风险，并且需要花费很长的时间才能完成。</p>
</li>
<li><p>可读性（readability）</p>
<p>软件设计大师 Martin Fowler 曾经说过：“Any fool can write code that a computer can understand. Good programmers write code that humans can understand.”翻译成中文就是：“任何傻瓜都会编写计算机能理解的代码。好的程序员能够编写人能够理解的代码。”Google 内部甚至专门有个认证就叫作 Readability。只有拿到这个认证的工程师，才有资格在 code review 的时候，批准别人提交代码。可见代码的可读性有多重要，毕竟，代码被阅读的次数远远超过被编写和执行的次数。我们需要看代码是否符合编码规范、命名是否达意、注释是否详尽、函数是否长短合适、模块划分是否清晰、是否符合高内聚低耦合等等。</p>
</li>
<li><p>可扩展性（extensibility）</p>
<p>可扩展性也是一个评价代码质量非常重要的标准。代码预留了一些功能扩展点，你可以把新功能代码，直接插到扩展点上，而不需要因为要添加一个功能而大动干戈，改动大量的原始代码。</p>
</li>
<li><p>可复用性（reusability）</p>
<p>代码的可复用性可以简单地理解为，尽量减少重复代码的编写，复用已有的代码。</p>
</li>
</ol>
<p>那么接下来就来优化一下代码吧：</p>
<h5 id="模块化"><a href="#模块化" class="headerlink" title="模块化"></a>模块化</h5><p>可以把登录的代码模块化，代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// lib/login.js</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">loginWithCallback</span>(<span class="hljs-params">cb</span>) &#123;<br>  <span class="hljs-comment">// 推荐使用wx.getUserProfile获取用户信息，开发者每次通过该接口获取用户个人信息均需用户确认</span><br>  <span class="hljs-comment">// 开发者妥善保管用户快速填写的头像昵称，避免重复弹窗</span><br>  wx.<span class="hljs-title function_">getUserProfile</span>(&#123;<br>    <span class="hljs-attr">desc</span>: <span class="hljs-string">&quot;用于完善会员资料&quot;</span>, <span class="hljs-comment">// 声明获取用户个人信息后的用途，后续会展示在弹窗中，请谨慎填写</span><br>    <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">let</span> &#123; userInfo, encryptedData, iv &#125; = res;<br>      <span class="hljs-keyword">const</span> <span class="hljs-title function_">requestLoginApi</span> = (<span class="hljs-params">code</span>) =&gt; &#123;<br>        <span class="hljs-comment">// 发起网络请求</span><br>        wx.<span class="hljs-title function_">request</span>(&#123;<br>          <span class="hljs-attr">url</span>: <span class="hljs-string">&quot;http://localhost:3000/user/weixin-login&quot;</span>,<br>          <span class="hljs-attr">method</span>: <span class="hljs-string">&quot;POST&quot;</span>,<br>          <span class="hljs-attr">header</span>: &#123;<br>            <span class="hljs-string">&quot;content-type&quot;</span>: <span class="hljs-string">&quot;application/json&quot;</span>,<br>          &#125;,<br>          <span class="hljs-attr">data</span>: &#123;<br>            code,<br>            userInfo,<br>            encryptedData,<br>            iv,<br>          &#125;,<br>          <span class="hljs-title function_">success</span>(<span class="hljs-params">res</span>) &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;请求成功&quot;</span>, res.<span class="hljs-property">data</span>);<br>            <span class="hljs-keyword">let</span> token = res.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>.<span class="hljs-property">authorizationToken</span>;<br>            wx.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">&quot;token&quot;</span>, token);<br>            <span class="hljs-title function_">onUserLogin</span>(token);<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;authorization&quot;</span>, token);<br>          &#125;,<br>          <span class="hljs-title function_">fail</span>(<span class="hljs-params">err</span>) &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;请求异常&quot;</span>, err);<br>          &#125;,<br>        &#125;);<br>      &#125;;<br><br>      <span class="hljs-keyword">const</span> <span class="hljs-title function_">onUserLogin</span> = (<span class="hljs-params">token</span>) =&gt; &#123;<br>        <span class="hljs-title function_">getApp</span>().<span class="hljs-property">globalData</span>.<span class="hljs-property">token</span> = token;<br>        wx.<span class="hljs-title function_">showToast</span>(&#123;<br>          <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;登录成功了&quot;</span>,<br>        &#125;);<br>        <span class="hljs-keyword">if</span> (cb &amp;&amp; <span class="hljs-keyword">typeof</span> cb == <span class="hljs-string">&quot;function&quot;</span>) <span class="hljs-title function_">cb</span>(token);<br>      &#125;;<br>      wx.<span class="hljs-title function_">checkSession</span>(&#123;<br>        <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>          <span class="hljs-comment">// session_key 未过期，并且在本生命周期一直有效</span><br>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;在登陆中&quot;</span>);<br>          <span class="hljs-keyword">let</span> token = wx.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">&quot;token&quot;</span>);<br>          <span class="hljs-keyword">if</span> (token) <span class="hljs-title function_">onUserLogin</span>(token);<br>        &#125;,<br>        <span class="hljs-attr">fail</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>          <span class="hljs-comment">// session_key已经失效，需要重新执行登录流程</span><br>          wx.<span class="hljs-title function_">login</span>(&#123;<br>            <span class="hljs-title function_">success</span>(<span class="hljs-params">res0</span>) &#123;<br>              <span class="hljs-keyword">if</span> (res0.<span class="hljs-property">code</span>) &#123;<br>                <span class="hljs-title function_">requestLoginApi</span>(res0.<span class="hljs-property">code</span>);<br>              &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;登录失败!&quot;</span> + res0.<span class="hljs-property">errMsg</span>);<br>              &#125;<br>            &#125;,<br>          &#125;);<br>        &#125;,<br>      &#125;);<br>    &#125;,<br>  &#125;);<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> loginWithCallback;<br></code></pre></td></tr></table></figure>

<h5 id="Promise化"><a href="#Promise化" class="headerlink" title="Promise化"></a>Promise化</h5><p>回调地狱问题，不利于代码的阅读，所以接下来我们基于<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise</a>进行代码优化。有了 Promise 对象，就可以将异步操作以同步操作的流程表达出来，避免了层层嵌套的回调函数。此外，Promise 对象提供统一的接口，使得控制异步操作更加容易。</p>
<p><strong>Promise的几个方法简介</strong></p>
<table>
<thead>
<tr>
<th>方法名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/then">Promise.prototype.then</a></td>
<td>方法返回的是一个新的 Promise 对象，因此可以采用链式写法。这种设计使得嵌套的异步操作，可以被很容易得改写，从回调函数的”横向发展”改为”向下发展”。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch">Promise.prototype.catch</a></td>
<td>是 Promise.prototype.then(null, rejection) 的别名，用于指定发生错误时的回调函数。Promise 对象的错误具有”冒泡”性质，会一直向后传递，直到被捕获为止。也就是说，错误总是会被下一个 catch 语句捕获。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/finally">Promise.prototype.finally</a></td>
<td>方法返回一个<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise"><code>Promise</code></a>。在promise结束时，无论结果是fulfilled或者是rejected，都会执行指定的回调函数。这为在<code>Promise</code>是否成功完成后都需要执行的代码提供了一种方式。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/all">Promise.all</a></td>
<td>这避免了同样的语句需要在<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/then"><code>then()</code></a>和<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch"><code>catch()</code></a>中各写一次的情况。Promise.all 方法用于将多个 Promise 实例，包装成一个新的 Promise 实例。Promise.all 方法接受一个数组作为参数，<code>var p = Promise.all([p1,p2,p3]);</code>p1、p2、p3 都是 Promise 对象的实例。（Promise.all 方法的参数不一定是数组，但是必须具有 iterator 接口，且返回的每个成员都是 Promise 实例。）p 的状态由 p1、p2、p3 决定，分成两种情况。  （1）只有p1、p2、p3的状态都变成fulfilled，p的状态才会变成fulfilled，此时p1、p2、p3的返回值组成一个数组，传递给p的回调函数。 （2）只要p1、p2、p3之中有一个被rejected，p的状态就变成rejected，此时第一个被reject的实例的返回值，会传递给p的回调函数。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/race">Promise.race</a></td>
<td>Promise.race 方法同样是将多个 Promise 实例，包装成一个新的 Promise 实例。<code>var p = Promise.race([p1,p2,p3]);</code>上面代码中，只要p1、p2、p3之中有一个实例率先改变状态，p的状态就跟着改变。那个率先改变的Promise实例的返回值，就传递给p的返回值。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/any">Promise.any</a></td>
<td>接收一个Promise可迭代对象，只要其中的一个 promise 成功，就返回那个已经成功的 promise 。所有子实例都处于rejected状态，总的promise才处于rejected状态。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/allSettled">Promise.allSettled</a></td>
<td>返回一个在所有给定的promise都已经<code>fulfilled</code>或<code>rejected</code>后的promise，并带有一个对象数组，每个对象表示对应的promise结果。相比之下，<code>Promise.all()</code> 更适合彼此相互依赖或者在其中任何一个<code>reject</code>时立即结束。</td>
</tr>
</tbody></table>
<h5 id="小程序API接口Promise化并且把需要登录的调用接口模块化"><a href="#小程序API接口Promise化并且把需要登录的调用接口模块化" class="headerlink" title="小程序API接口Promise化并且把需要登录的调用接口模块化"></a>小程序API接口Promise化并且把需要登录的调用接口模块化</h5><ol>
<li>安装插件。请先查看<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/devtools/npm.html">npm支持</a>文档。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install --save miniprogram-api-promise<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>在微信开发者工具右方详情中勾选使用npm模块，并在菜单栏工具中点击构建npm。</li>
<li>初始化代码。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// app.js</span><br><span class="hljs-keyword">import</span> &#123;promisifyAll&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;miniprogram-api-promise&#x27;</span><br><span class="hljs-keyword">import</span> login <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../lib/login&quot;</span>;<br><span class="hljs-keyword">const</span> wxp =&#123;&#125;<br><span class="hljs-title function_">promisifyAll</span>(wx,wxp)<br><span class="hljs-comment">// 需要token的请求统一处理登录和设置header，并且处理错误信息</span><br>wxp.<span class="hljs-property">requestNeedLogin</span> = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) &#123;<br>  <span class="hljs-keyword">let</span> token = wx.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">&quot;token&quot;</span>);<br>  <span class="hljs-keyword">if</span> (!token) &#123;<br>    token = <span class="hljs-keyword">await</span> <span class="hljs-title function_">loginWithPromise</span>();<br>  &#125;<br>  <span class="hljs-keyword">if</span> (!args.<span class="hljs-property">header</span>) args.<span class="hljs-property">header</span> = &#123;&#125;;<br>  args.<span class="hljs-property">header</span>[<span class="hljs-string">&quot;Authorization&quot;</span>] = <span class="hljs-string">`Bearer <span class="hljs-subst">$&#123;token&#125;</span>`</span>;<br>  <span class="hljs-keyword">return</span> wxp.<span class="hljs-title function_">request</span>(args).<span class="hljs-title function_">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>);<br>&#125;;<br><span class="hljs-comment">// app.js</span><br><span class="hljs-title class_">App</span>(&#123;<br>  <span class="hljs-attr">wxp</span>:wxp,<br>&#125;);<br></code></pre></td></tr></table></figure>

<ol start="4">
<li>改写login.js代码</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// lib/login.js</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">login</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// 推荐使用wx.getUserProfile获取用户信息，开发者每次通过该接口获取用户个人信息均需用户确认</span><br>    <span class="hljs-comment">// 开发者妥善保管用户快速填写的头像昵称，避免重复弹窗</span><br>    wx.<span class="hljs-title function_">getUserProfile</span>(&#123;<br>      <span class="hljs-attr">desc</span>: <span class="hljs-string">&quot;用于完善会员资料&quot;</span>, <span class="hljs-comment">// 声明获取用户个人信息后的用途，后续会展示在弹窗中，请谨慎填写</span><br>       <span class="hljs-attr">success</span>:<span class="hljs-keyword">async</span> (res0) =&gt; &#123;<br>        <span class="hljs-keyword">let</span> &#123;<br>          userInfo,<br>          encryptedData,<br>          iv<br>        &#125; = res0;<br>        <span class="hljs-keyword">const</span> app = <span class="hljs-title function_">getApp</span>();<br>        <span class="hljs-keyword">try</span> &#123;<br>          app.<span class="hljs-property">wxp</span>.<span class="hljs-title function_">checkSession</span>();<br>        &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>          <span class="hljs-title function_">reject</span>(err);<br>        &#125;<br>        <span class="hljs-keyword">let</span> token = wx.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">&quot;token&quot;</span>);<br>        <span class="hljs-keyword">if</span> (!token) &#123;<br>          <span class="hljs-keyword">let</span> res1 = <span class="hljs-keyword">await</span> app.<span class="hljs-property">wxp</span>.<span class="hljs-title function_">login</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-title function_">reject</span>(err));<br>          <span class="hljs-keyword">let</span> code = res1.<span class="hljs-property">code</span>;<br>          <span class="hljs-keyword">let</span> res = <span class="hljs-keyword">await</span> app.<span class="hljs-property">wxp</span>.<span class="hljs-title function_">request</span>(&#123;<br>            <span class="hljs-attr">url</span>: <span class="hljs-string">&quot;http://localhost:3000/user/weixin-login&quot;</span>,<br>            <span class="hljs-attr">method</span>: <span class="hljs-string">&quot;POST&quot;</span>,<br>            <span class="hljs-attr">header</span>: &#123;<br>              <span class="hljs-string">&quot;content-type&quot;</span>: <span class="hljs-string">&quot;application/json&quot;</span>,<br>            &#125;,<br>            <span class="hljs-attr">data</span>: &#123;<br>              code,<br>              userInfo,<br>              encryptedData,<br>              iv,<br>            &#125;<br>          &#125;).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-title function_">reject</span>(err));<br>          token = res.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>.<span class="hljs-property">authorizationToken</span>;<br>          wx.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">&quot;token&quot;</span>, token);<br>          app.<span class="hljs-property">globalData</span>.<span class="hljs-property">token</span> = token;<br>          wx.<span class="hljs-title function_">showToast</span>(&#123;<br>            <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;登录成功了&quot;</span>,<br>          &#125;);<br>          <span class="hljs-title function_">resolve</span>(token);<br>        &#125;<br>      &#125;,<br>    &#125;);<br>  &#125;)<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> login;<br></code></pre></td></tr></table></figure>

<ol start="5">
<li>调用代码</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;container page-head&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">text</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;page-section__title&quot;</span>&gt;</span>需要登录的请求调用<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn-area&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">bindtap</span>=<span class="hljs-string">&quot;request1&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;primary&quot;</span>&gt;</span>请求1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">bindtap</span>=<span class="hljs-string">&quot;request2&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;primary&quot;</span>&gt;</span>请求2<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// pages/index.js</span><br><span class="hljs-title class_">Page</span>(&#123;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 页面的初始数据</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-attr">data</span>: &#123;&#125;,<br>  <span class="hljs-title function_">request1</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">getApp</span>().<span class="hljs-property">wxp</span>.<span class="hljs-title function_">requestNeedLogin</span>(&#123;<br>        <span class="hljs-attr">url</span>: <span class="hljs-string">&quot;http://localhost:3000/user/home?name=andying&quot;</span>,<br>      &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>)<br>  &#125;,<br>  <span class="hljs-title function_">request2</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">getApp</span>().<span class="hljs-property">wxp</span>.<span class="hljs-title function_">requestNeedLogin</span>(&#123;<br>        <span class="hljs-attr">url</span>: <span class="hljs-string">&quot;http://localhost:3000/user/home?name=eva&quot;</span>,<br>      &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>)<br>  &#125;,<br>&#125;);<br></code></pre></td></tr></table></figure>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Wechat/">Wechat</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E7%99%BB%E5%BD%95/">登录</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/Wechat/wechat-icon/">
                        <span class="hidden-mobile">微信小程序Icon图标的几个实现方案</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/ivivisoft" target="_blank" rel="nofollow noopener"><span>IvIvI</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
